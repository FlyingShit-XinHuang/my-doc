## ACID

* A，Atomicity，原子性。简单理解即事务中的操作要么都成功，要么都失败。
* C，Consistency，一致性。无论事务并发量多大，事务执行前后，系统仍保持一致状态。如账户间互相转账，转账事务结束之后，账户总余额不变。
* I，Isolation，隔离性。对同一数据处理得并发事务之间互不影响，执行效果如同串行执行。
* D，Durability，持久性。事务完成之后，更新会被持久的保存。

## 事务并发的问题

* 脏读：事务A读取了事务B更新的数据，然后B回滚操作，那么A读取到的数据是脏数据
* 不可重复读：事务 A 多次读取同一数据，事务 B 在事务A读取的过程中，对数据作了更新并提交，导致事务A多次读取同一数据时，结果不一致。
* 幻读：系统管理员A将数据库中所有学生的成绩从具体分数改为ABCDE等级，但是系统管理员B就在这个时候插入了一条具体分数的记录，当系统管理员A改结束后发现还有一条记录没有改过来，就好像发生了幻觉一样，这就叫幻读。

## 事务隔离级别

* read-uncommitted
* read-commited。可解决脏读的问题。写数据会锁住行。
* repeatable-read。默认的隔离级别，可解决脏读和不可重复读的问题。如果检索条件没有索引，更新会锁住整张表，否则会加next-key锁
* serializable。读写会锁表，可解决脏读、不可重复读和幻读的问题。

隔离级别越高，越能保证数据的完整性和一致性，但是对并发性能的影响也越大。

## 锁

### 共享锁（又称读锁）、排它锁（又称写锁）

* 共享锁（S）：允许一个事务去读一行，阻止其他事务获得相同数据集的排他锁。
* 排他锁（X)：允许获得排他锁的事务更新数据，阻止其他事务取得相同数据集的共享读锁和排他写锁。
* 意向共享锁（IS）：事务打算给数据行加行共享锁，事务在给一个数据行加共享锁前必须先取得该表的IS锁。
* 意向排他锁（IX）：事务打算给数据行加行排他锁，事务在给一个数据行加排他锁前必须先取得该表的IX锁。

共享锁和排他锁都是行锁，意向锁都是表锁，应用中我们只会使用到共享锁和排他锁，意向锁是mysql内部使用的，不需要用户干预。
意向锁的作用就是当一个事务在需要获取资源锁定的时候，如果遇到自己需要的资源已经被排他锁占用的时候，该事务可以需要锁定行的表上面添加一个合适的意向锁。

对于普通SELECT语句，InnoDB不会加任何锁，事务可以通过以下语句显示给记录集加共享锁或排他锁：
* 共享锁（S）：SELECT * FROM table_name WHERE ... LOCK IN SHARE MODE。
* 排他锁（X)：SELECT * FROM table_name WHERE ... FOR UPDATE。

InnoDB行锁是通过给索引上的索引项加锁来实现的，因此InnoDB这种行锁实现特点意味着：只有通过索引条件检索数据，InnoDB才使用行级锁，否则，InnoDB将使用表锁！

即便在条件中使用了索引字段，但是否使用索引来检索数据是由MySQL通过判断不同执行计划的代价来决定的，如果MySQL认为全表扫描效率更高，比如对一些很小的表，它就不会使用索引，这种情况下InnoDB将使用表锁，而不是行锁。因此，在分析锁冲突时，别忘了检查SQL的执行计划，以确认是否真正使用了索引。

### 间隙锁

当我们用范围条件而不是相等条件检索数据，并请求共享或排他锁时，InnoDB会给符合条件的已有数据记录的索引项加锁；

对于键值在条件范围内但并不存在的记录，叫做“间隙（GAP)”，InnoDB也会对这个“间隙”加锁，这种锁机制就是所谓的间隙锁（Next-Key锁）。

如果使用相等条件的query给一个不存在的记录加锁，InnoDB也会使用间隙锁。

当query使用的where还包含非索引列时，索引键所指向的数据可能有部分并不属于该query的结果集的行列，但是也会被锁定。

## MVCC

每行记录有两个隐藏字段：创建时间和删除时间，保存对应操作的事务id。

* insert时，创建时间保存当前事务id。
* delete时，删除时间保存当前事务id。
* update时，删除时间保存当前事务id，并添加新记录，其创建时间保存当前事务id。
* 查询时，返回满足以下条件的row：
  * 创建时间小于等于当前事务id
  * 删除时间未定义或大于当前事务id

## 参考资料

* https://www.jianshu.com/p/4e3edbedb9a8
* https://www.cnblogs.com/huanongying/p/7021555.html
* https://www.cnblogs.com/protected/p/6526857.html
* https://www.cnblogs.com/aipiaoborensheng/p/5767459.html
* https://www.cnblogs.com/dongqingswt/p/3460440.html